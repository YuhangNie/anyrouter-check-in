name: Check-in Automation
on:
  schedule:
    # 每6小时执行，添加分钟随机偏移避免整点拥堵
    - cron: '17 */6 * * *'
  workflow_dispatch:
    inputs:
      skip_delay:
        description: '跳过随机延迟'
        required: false
        default: 'true'
        type: boolean
  repository_dispatch:
    types: [telegram_checkin]

# 防止多个工作流同时运行
concurrency:
  group: checkin-${{ github.ref }}
  cancel-in-progress: false

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    env:
      PYTHONIOENCODING: utf-8
      TZ: Asia/Shanghai
    steps:
    - name: 随机延迟 (定时任务)
      if: github.event_name == 'schedule'
      run: |
        DELAY=$((RANDOM % 300))
        echo "⏳ 随机延迟 ${DELAY} 秒..."
        sleep $DELAY

    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: 缓存 UV 依赖
      uses: actions/cache@v4
      id: uv-cache
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: 安装依赖
      run: |
        uv sync
        echo "✅ 依赖安装完成"

    - name: 获取 Playwright 版本
      id: playwright-version
      run: |
        version=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('playwright'))")
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: 缓存 Playwright 浏览器
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: 安装 Playwright 浏览器
      run: |
        sudo apt-get update && sudo apt-get install -y xvfb
        if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
          uv run playwright install chromium --with-deps
        fi

    - name: 恢复余额历史缓存
      uses: actions/cache@v4
      with:
        path: balance_hash.txt
        key: balance-hash-${{ github.sha }}
        restore-keys: |
          balance-hash-

    - name: 执行签到
      id: checkin
      env:
        ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
        PROVIDERS: ${{ secrets.PROVIDERS }}
        DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
        FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
        GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        GOTIFY_PRIORITY: ${{ secrets.GOTIFY_PRIORITY }}
      run: |
        xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" uv run checkin.py

    - name: 执行结果
      if: always()
      run: |
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        if [ "${{ steps.checkin.outcome }}" == "success" ]; then
          echo "✅ 签到成功"
        else
          echo "❌ 签到失败"
        fi
        echo "⏰ $(date '+%Y-%m-%d %H:%M:%S')"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
