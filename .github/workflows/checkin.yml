name: Check-in Automation
on:
  schedule:
    # æ¯6å°æ—¶æ‰§è¡Œï¼Œæ·»åŠ åˆ†é’Ÿéšæœºåç§»é¿å…æ•´ç‚¹æ‹¥å µ
    - cron: '17 */6 * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ (ä¿å­˜æˆªå›¾å’Œè¯¦ç»†æ—¥å¿—)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_delay:
        description: 'è·³è¿‡éšæœºå»¶è¿Ÿ (æ‰‹åŠ¨è§¦å‘æ—¶)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# é˜²æ­¢å¤šä¸ªå·¥ä½œæµåŒæ—¶è¿è¡Œ
concurrency:
  group: checkin-${{ github.ref }}
  cancel-in-progress: false

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    env:
      PYTHONIOENCODING: utf-8
      TZ: Asia/Shanghai
    steps:
    - name: éšæœºå»¶è¿Ÿ (å®šæ—¶ä»»åŠ¡)
      if: github.event_name == 'schedule' || inputs.skip_delay == 'false'
      run: |
        DELAY=$((RANDOM % 300))
        echo "â³ éšæœºå»¶è¿Ÿ ${DELAY} ç§’ï¼Œé¿å…æ£€æµ‹..."
        sleep $DELAY

    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ç¼“å­˜ UV ä¾èµ–
      uses: actions/cache@v4
      id: uv-cache
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: å®‰è£…ä¾èµ–
      run: |
        if [ "${{ steps.uv-cache.outputs.cache-hit }}" != "true" ]; then
          echo "ğŸ“¦ ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
        else
          echo "ğŸ“¦ ä»ç¼“å­˜æ¢å¤ä¾èµ–ï¼ŒéªŒè¯ç¯å¢ƒ..."
        fi
        uv sync
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: è·å– Playwright ç‰ˆæœ¬
      id: playwright-version
      run: |
        version=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('playwright'))")
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "ğŸ­ Playwright version: $version"

    - name: ç¼“å­˜ Playwright æµè§ˆå™¨
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: å®‰è£… Playwright æµè§ˆå™¨å’Œ Xvfb
      run: |
        # å®‰è£… xvfb ç”¨äºè™šæ‹Ÿæ˜¾ç¤ºå™¨ï¼ˆæ”¯æŒ headed æ¨¡å¼ç»•è¿‡ WAFï¼‰
        sudo apt-get update
        sudo apt-get install -y xvfb

        # å®‰è£… Playwright æµè§ˆå™¨ï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰
        if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
          echo "ğŸŒ ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹å®‰è£… Playwright æµè§ˆå™¨..."
          uv run playwright install chromium --with-deps
        else
          echo "ğŸŒ ä»ç¼“å­˜æ¢å¤ Playwright æµè§ˆå™¨"
        fi

    - name: æ¢å¤ä½™é¢å†å²ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: balance_hash.txt
        key: balance-hash-${{ github.sha }}
        restore-keys: |
          balance-hash-

    - name: æ‰§è¡Œç­¾åˆ°
      id: checkin
      env:
        ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
        PROVIDERS: ${{ secrets.PROVIDERS }}
        DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
        FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
        GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        GOTIFY_PRIORITY: ${{ secrets.GOTIFY_PRIORITY }}
        DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
      run: |
        xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" uv run checkin.py

    - name: ä¸Šä¼ è°ƒè¯•æˆªå›¾
      if: failure() || inputs.debug_mode == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: debug-screenshots-${{ github.run_id }}
        path: |
          screenshots/
          *.png
          debug_*.log
        retention-days: 7
        if-no-files-found: ignore

    - name: æ‰§è¡Œç»“æœ
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ "${{ steps.checkin.outcome }}" == "success" ]; then
          echo "âœ… ç­¾åˆ°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
        fi
        echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ”— è¿è¡Œé“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
